{#frontend/templates/admin/projects/index.html#}
{% extends "admin/master.html" %}
{% block title %}Projects{% endblock %}

{% block content %}
<div class="page-head">
  <h3>Projects</h3>
  {% if perms.create %}
    <a class="btn btn-primary" href="/admin/projects/new">
      <i class="fas fa-plus"></i> New Project
    </a>
  {% endif %}
</div>

<form class="search-bar" method="get" action="/admin/projects">
  <input type="text" name="q" value="{{ q }}" placeholder="Search slug/name/title/location/status/type">
  <button class="btn" type="submit" aria-label="Search"><i class="fas fa-search"></i></button>
</form>

{% if flashes and flashes|length %}
  <div class="flash-stack">
    {% for f in flashes %}
      <div class="alert alert-{{ f.category }}">{{ f.message }}</div>
    {% endfor %}
  </div>
{% endif %}

<div class="card" style="padding:12px;">
  <div class="table-scroll">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Title and Slug</th>
          <th class="fit">Type</th>
          <th class="fit">Status</th>
          <th>Location</th>
          <th class="fit">Progress</th>
          <th class="fit">Branch Code</th>
          <th class="fit">Branch Name</th>
          <th class="fit">Owner / Employee ID</th>
          <th class="fit">Employee Name</th>
          <th class="table-actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td class="nowrap">
            {% if perms.edit %}
              <a class="btn btn-xs" href="/admin/projects/{{ r.id }}/edit" title="Click to edit">{{ r.id }}</a>
            {% endif %}
          </td>
          <td>
            <div class="wrap" style="font-weight:700;">{{ r.title or r.name }}</div>
            <div class="muted" style="font-size:12px;">{{ r.slug }}</div>
          </td>
          <td class="nowrap">{{ (r.ptype)|capitalize }}</td>
          <td class="nowrap">{{ r.status|capitalize }}</td>
          <td class="wrap">{{ r.location or '-' }}</td>
          <td class="nowrap">{{ (r.progress_pct or 0) }}%</td>

          {# New columns fed from route enrichment #}
          <td class="nowrap">{{ r.br_id or '-' }}</td>
          <td class="nowrap">{{ r.br_name or '-' }}</td>
          <td class="nowrap">{{ r.emp_id or '-' }}</td>
          <td class="nowrap">{{ r.emp_name or '-' }}</td>

          <td class="actions">
            {% if perms.edit %}
              <a class="btn btn-xs" href="/admin/projects/{{ r.id }}/edit" title="Edit"><i class="fas fa-edit"></i></a>
            {% endif %}
            {% if perms.delete %}
              <form method="post" action="/admin/projects/{{ r.id }}/delete"
                    class="delete-confirm"
                    message-confirm="Delete project '{{ r.title or r.name }}' (#{{ r.id }})?"
                    style="display:inline;">
                <input type="hidden" name="csrf_token" value="{{ request.cookies.get('XSRF-TOKEN','') }}">
                <button class="btn btn-xs btn-danger" title="Delete"><i class="fas fa-trash"></i></button>
              </form>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr><td colspan="11" class="muted">No projects found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if pages > 1 %}
<div class="pagination">
  {% for p in range(1, pages+1) %}
    <a class="page {{ 'active' if p==page }}"
       href="/admin/projects?page={{p}}&size={{size}}{% if q %}&q={{ q }}{% endif %}">
      {{ p }}
    </a>
  {% endfor %}
</div>
{% endif %}
{% endblock %}